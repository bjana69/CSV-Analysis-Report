<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Automated Statistical Report</title>
    <style>
      /*
         * Light themed, skyâ€‘blue UI with a glassy card. The page uses flexbox to
         * centre the card and keeps the form elements neatly aligned. A small
         * progress bar appears during processing to give feedback while the
         * backend prepares the PDF. Font sizes and spacing are tuned for
         * readability on both desktop and mobile devices.
         */
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: linear-gradient(180deg, #e0f7ff 0%, #f8fcff 100%);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        color: #333;
      }

      .card {
        margin-top: 40px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 12px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        padding: 30px;
        width: 90%;
        max-width: 600px;
      }

      h1 {
        text-align: center;
        margin-top: 0;
        font-size: 24px;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
      }

      label {
        margin-bottom: 5px;
        font-weight: bold;
      }

      input[type="file"] {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      select,
      input[type="checkbox"] {
        padding: 6px;
      }

      .task-options {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
      }

      .buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
      }

      button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      button#submitBtn {
        background: #0077b6;
        color: #fff;
      }

      button#resetBtn {
        background: #f06292;
        color: #fff;
      }

      button:hover {
        opacity: 0.9;
      }

      .progress-container {
        width: 100%;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 20px;
        display: none;
      }

      .progress-bar {
        height: 16px;
        width: 0;
        background: #00b4d8;
        transition: width 0.2s ease;
      }

      .progress-text {
        margin-top: 5px;
        font-size: 14px;
        text-align: right;
      }

      #downloadSection {
        margin-top: 30px;
      }

      /* Error message styling.  Displayed when backend returns an error.
         Uses red text on a light red background for high visibility. */
      .error-message {
        display: none;
        color: #b00020;
        background: #fdecea;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 10px;
        margin-top: 15px;
        font-weight: bold;
      }

      .download-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-bottom: 10px;
        background: rgba(255, 255, 255, 0.8);
      }

      .download-item span {
        flex-grow: 1;
      }

      .download-item a {
        text-decoration: none;
        color: #0077b6;
        font-weight: bold;
      }

      @media (max-width: 480px) {
        .card {
          padding: 20px;
        }
        h1 {
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Automated Statistical Report</h1>
      <div class="form-group">
        <label for="csvFileInput">Upload CSV File</label>
        <input type="file" id="csvFileInput" accept=".csv" />
      </div>
      <div class="form-group">
        <label
          ><input type="checkbox" id="useLLM" /> Use LLM for enrichment</label
        >
      </div>
      <div class="form-group">
        <label>Select Task Type</label>
        <div class="task-options">
          <label
            ><input type="radio" name="taskType" value="regression" />
            Regression</label
          >
          <label
            ><input type="radio" name="taskType" value="classification" />
            Classification</label
          >
        </div>
      </div>
      <div class="form-group">
        <label for="targetSelect">Select Target Column</label>
        <select id="targetSelect">
          <option value="" disabled selected>Upload a CSV to populate</option>
        </select>
      </div>
      <div class="buttons">
        <button id="submitBtn">Submit</button>
        <button id="resetBtn">Reset</button>
      </div>
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
        <div class="progress-text" id="progressText">0%</div>
      </div>
      <!-- Error message container (hidden by default) -->
      <div id="errorMessage" class="error-message"></div>
      <div id="downloadSection"></div>
    </div>
    <script>
      // Utility to split a CSV header line taking into account quoted fields
      function splitCsvHeader(line) {
        const cols = [];
        let current = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            inQuotes = !inQuotes;
            current += ch;
            continue;
          }
          // comma outside quotes marks a separator
          if (ch === "," && !inQuotes) {
            cols.push(current);
            current = "";
            continue;
          }
          current += ch;
        }
        cols.push(current);
        // Trim whitespace and remove surrounding quotes from each entry
        return cols.map((c) => {
          c = c.trim();
          if (c.startsWith('"') && c.endsWith('"')) {
            c = c.slice(1, -1);
          }
          return c.trim();
        });
      }

      // Strip surrounding quotes from a string
      function stripQuotes(s) {
        s = (s || "").trim();
        if (
          (s.startsWith('"') && s.endsWith('"')) ||
          (s.startsWith("'") && s.endsWith("'"))
        ) {
          s = s.slice(1, -1);
        }
        return s.trim();
      }
      // Helper to read CSV header from uploaded file and populate target dropdown
      document
        .getElementById("csvFileInput")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          const targetSelect = document.getElementById("targetSelect");
          targetSelect.innerHTML = "";
          if (!file) {
            const opt = document.createElement("option");
            opt.textContent = "Upload a CSV to populate";
            opt.disabled = true;
            opt.selected = true;
            targetSelect.appendChild(opt);
            return;
          }
          const reader = new FileReader();
          reader.onload = function (evt) {
            const text = evt.target.result;
            // split by newline and get first line
            const firstLine = text.split(/\r?\n/)[0];
            // Use robust header parser to handle quoted column names
            const columns = splitCsvHeader(firstLine);
            columns.forEach((col) => {
              const opt = document.createElement("option");
              opt.value = col;
              opt.textContent = col;
              targetSelect.appendChild(opt);
            });
          };
          reader.readAsText(file);
        });

      // Reset form
      document
        .getElementById("resetBtn")
        .addEventListener("click", function () {
          document.getElementById("csvFileInput").value = "";
          document.getElementById("useLLM").checked = false;
          document
            .querySelectorAll('input[name="taskType"]')
            .forEach((r) => (r.checked = false));
          const targetSelect = document.getElementById("targetSelect");
          targetSelect.innerHTML = "";
          const opt = document.createElement("option");
          opt.textContent = "Upload a CSV to populate";
          opt.disabled = true;
          opt.selected = true;
          targetSelect.appendChild(opt);
          hideProgress();
          clearError();
        });

      function hideProgress() {
        const bar = document.getElementById("progressBar");
        const text = document.getElementById("progressText");
        const container = document.getElementById("progressContainer");
        container.style.display = "none";
        bar.style.width = "0%";
        text.textContent = "0%";
      }

      // Show an error message in the dedicated container.  Hides the progress bar.
      function showError(message) {
        hideProgress();
        const errDiv = document.getElementById("errorMessage");
        errDiv.textContent = message;
        errDiv.style.display = "block";
      }

      // Clear any displayed error message.
      function clearError() {
        const errDiv = document.getElementById("errorMessage");
        errDiv.textContent = "";
        errDiv.style.display = "none";
      }

      function updateProgress(percent) {
        const bar = document.getElementById("progressBar");
        const text = document.getElementById("progressText");
        bar.style.width = percent + "%";
        text.textContent = percent.toFixed(0) + "%";
      }

      // Submit form and call backend
      document
        .getElementById("submitBtn")
        .addEventListener("click", function () {
          const fileInput = document.getElementById("csvFileInput");
          const useLLM = document.getElementById("useLLM").checked;
          const taskRadio = document.querySelector(
            'input[name="taskType"]:checked'
          );
          const target = document.getElementById("targetSelect").value;
          clearError();
          if (!fileInput.files[0]) {
            showError("Please upload a CSV file.");
            return;
          }
          if (!taskRadio) {
            showError("Please select a task type.");
            return;
          }
          if (!target) {
            showError("Please select a target column.");
            return;
          }
          // Read file content as base64 and send JSON payload
          const container = document.getElementById("progressContainer");
          container.style.display = "block";
          let progress = 0;
          updateProgress(progress);
          const interval = setInterval(() => {
            if (progress < 90) {
              progress += Math.random() * 10;
              if (progress > 90) progress = 90;
              updateProgress(progress);
            }
          }, 500);
          const file = fileInput.files[0];
          const reader = new FileReader();
          reader.onload = function (evt) {
            // evt.target.result is a DataURL: data:...;base64,...
            const dataURL = evt.target.result;
            const base64String = dataURL.split(",")[1];
            const payload = {
              file_name: file.name,
              content: base64String,
              task_type: taskRadio.value,
              target: stripQuotes(target),
              use_llm: useLLM,
            };
            fetch(`http://127.0.0.1:8000/api/analyze`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            })
              .then((response) => {
                clearInterval(interval);
                // If the response is not OK attempt to extract error detail
                if (!response.ok) {
                  return response
                    .json()
                    .then((err) => {
                      const msg =
                        err && err.detail ? err.detail : response.statusText;
                      throw new Error(msg);
                    })
                    .catch(() => {
                      throw new Error(response.statusText || "Request failed");
                    });
                }
                return response.json();
              })
              .then((data) => {
                updateProgress(100);
                setTimeout(() => {
                  hideProgress();
                }, 1000);
                if (data && data.pdf_url) {
                  addDownloadItem(data);
                }
              })
              .catch((error) => {
                clearInterval(interval);
                showError(error.message);
              });
          };
          reader.readAsDataURL(file);
        });

      // Add new download entry to the page
      function addDownloadItem(data) {
        const section = document.getElementById("downloadSection");
        const item = document.createElement("div");
        item.classList.add("download-item");
        const fileName = document.createElement("span");
        fileName.textContent = data.file_name || "generated_report.pdf";
        const link = document.createElement("a");
        link.href = `http://127.0.0.1:8000${data.pdf_url}`;
        link.textContent = "Download";
        link.setAttribute("download", data.file_name || "report.pdf");
        item.appendChild(fileName);
        item.appendChild(link);
        section.appendChild(item);
      }
    </script>
  </body>
</html>
